<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识问答助手</title>
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script>
    <style>
        :root {
            --primary-color: #4A89E8;
            --primary-color-light: #e9f2ff;
            --background-color: #f5f7fa;
            --widget-bg-color: #ffffff;
            --text-color-primary: #1a1a1a;
            --text-color-secondary: #5f6368;
            --border-color: #e0e4e8;
            --bot-message-bg: #f8f9fb;
            --user-message-bg: var(--primary-color-light);
            --shadow-color: rgba(0, 0, 0, 0.08);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            display: block;
            min-height: 100vh;
        }
        .chat-widget {
            width: 100%;
            height: 100vh;
            max-height: none;
            border-radius: 0;
            box-shadow: none;
            background-color: var(--widget-bg-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .chat-header {
            padding: 16px 24px;
            background-color: var(--widget-bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .header-title-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6B73FF, #4F5BFF);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            color: white;
            font-size: 20px;
        }
        .header-title h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color-primary);
        }
        .header-actions svg {
            width: 22px;
            height: 22px;
            cursor: pointer;
            color: var(--text-color-secondary);
            transition: color 0.2s, transform 0.2s;
        }
        .chat-body {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 0;
        }
        .message {
            display: flex;
            margin-bottom: 16px;
            max-width: 80%;
            animation: fadeInUp 0.5s ease;
        }
        .message-container {
            display: flex;
            flex-direction: column;
        }
        .message-content {
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .bot-message .message-content {
            background-color: var(--bot-message-bg);
            border-top-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        .user-message .message-content {
            background-color: var(--user-message-bg);
            color: #1a2a44;
            border-top-right-radius: 4px;
        }
        .bot-message {
            align-self: flex-start;
            gap: 12px;
        }
        .bot-message .avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6B73FF, #4F5BFF);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }
        .user-message {
            align-self: flex-end;
        }
        /* --- 猜你想问 & 后续问题通用样式 --- */
        .question-list-container {
            padding: 8px;
            animation: fadeIn 0.5s ease;
            background-color: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 2px 6px var(--shadow-color);
            margin: 0 16px;
        }
        .question-list-title {
            color: var(--text-color-secondary);
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 500;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-color);
        }
        .question-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-size: 14px;
            color: var(--text-color-primary);
            background-color: #f9fafc;
            border: 1px solid transparent;
        }
        .question-item:last-child {
            margin-bottom: 0;
        }
        .question-item:hover {
            background-color: #f1f3f5;
            transform: translateY(-1px);
            border-color: var(--border-color);
        }
        .question-item-icon {
            width: 6px;
            height: 6px;
            background-color: #ffe5e7;
            border: 1px solid #e57373;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .chat-input-area {
            border-top: 1px solid var(--border-color);
            padding: 10px 24px;
            background-color: var(--widget-bg-color);
            flex-shrink: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
        }
        .input-wrapper {
            width: 90%;
            max-width: 400px;
            margin: 0 auto;
            height: 48px;
            display: flex;
            align-items: center;
            background-color: #f5f6f8;
            border-radius: 24px;
            padding: 0 16px;
            gap: 12px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(74, 137, 232, 0.2);
        }
        .input-actions .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .chat-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 0;
            font-size: 15px;
            color: var(--text-color-primary);
            resize: none;
            height: auto;
            max-height: 120px;
            line-height: 48px;
        }
        .chat-input:focus {
            outline: none;
        }
        .send-button {
            background-color: var(--primary-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(74, 137, 232, 0.3);
        }
        .send-button:hover {
            transform: scale(1.05);
            background-color: #3a79d8;
            box-shadow: 0 6px 14px rgba(74, 137, 232, 0.4);
        }
        .send-button svg {
            color: white;
            width: 22px;
            height: 22px;
        }
        .disclaimer {
            font-size: 11px;
            color: #b0b4b8;
            text-align: center;
            margin-top: 10px;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 弹窗样式 */
        .source-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            display: flex;
            flex-direction: row;
            width: 95%;
            max-width: 1400px;
            height: auto;
            min-height: 90vh;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            color: #5f6368;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 18px;
            line-height: 30px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }
        .image-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        .image-container:last-child {
            border-right: none;
        }
        .image-title {
            color: #1a1a1a;
            margin: 0 0 10px;
            font-size: 16px;
            text-align: center;
        }
        
        /* docx-preview 样式，确保内容铺满 */
        .docx-preview {
            width: 100% !important; /* 强制宽度为100% */
            max-width: 100%;
            height: auto;
            box-sizing: border-box; /* 包含padding和border在内的总宽度 */
        }
    </style>
</head>
<body>
    <div class="chat-widget">
        <header class="chat-header">
            <div class="header-title-container">
                <div class="header-icon">智</div>
                <div class="header-title"><h3>智能助手</h3></div>
            </div>
            <div class="header-actions">
                <svg title="关闭" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41z"></path></svg>
            </div>
        </header>
        <div class="chat-body" id="chat-body">
            <div class="message bot-message" id="initial-welcome">
                <div class="avatar">智</div>
                <div class="message-container">
                    <div class="message-content">您好，我是您的制度解答助手，请问有什么可以帮您？</div>
                </div>
            </div>
            <div class="question-list-container">
                <div class="question-list-title">———— 猜你想问 ————</div>
                <div class="question-list">
                    <div class="question-item" onclick="selectQuestion('总结安东和斯伦贝谢QHSE原则的差异')">
                        <div class="question-item-icon"></div>
                        <div>总结安东和斯伦贝谢QHSE原则的差异</div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="chat-input-area">
            <div class="input-wrapper">
                <textarea id="chat-input" class="chat-input" placeholder="输入您的问题..." rows="1"></textarea>
                <button class="send-button" id="send-button" title="发送">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12L2.01 3L2 10l15 2l-15 2z"></path></svg>
                </button>
            </div>
            <p class="disclaimer">部分内容由AI大模型智能生成，不代表厂商的观点</p>
        </footer>
    </div>

    <div id="source-modal" class="source-modal">
        <div class="modal-content">
            <button id="close-modal" class="close-modal">&times;</button>
            <div class="image-container">
                <h3 class="image-title">安东-安东石油QHSE（安全生产）管理规定(ZD-ZH-016V0-2021</h3>
                <div id="anton-docx-container" style="width: 100%; height: 80vh; overflow-y: auto;"></div>
            </div>
            <div class="image-container">
                <h3 class="image-title">斯伦贝谢-HSE_to_Go_Handbook</h3>
                <div id="schlumberger-docx-container" style="width: 100%; height: 80vh; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        const chatBody = document.getElementById('chat-body');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const modal = document.getElementById('source-modal');
        const closeModalBtn = document.getElementById('close-modal');

        // 关闭弹窗
        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
        });

        // 辅助函数：获取 docx 每页节点（兼容多种结构）
        function getDocxPages(container) {
            const selectors = [
                '.docx .page',
                '.docx-page',
                '.docx-wrapper .page',
                '.docx .docx-page',
                '.docx-preview .page',
                '.docx .document .page'
            ];
            for (const sel of selectors) {
                const nodes = container.querySelectorAll(sel);
                if (nodes && nodes.length > 1) return Array.from(nodes);
                if (nodes && nodes.length === 1) {
                    const sub = nodes[0].querySelectorAll('.page, .docx-page, section');
                    if (sub && sub.length > 0) return Array.from(sub);
                }
            }
            // 尝试从 wrapper 内部查找
            const wrapper = container.querySelector('.docx, .docx-preview, .docx-wrapper');
            if (wrapper) {
                const directChildren = Array.from(wrapper.children || []);
                if (directChildren.length > 1) return directChildren;
                const subPages = wrapper.querySelectorAll('.page, .docx-page, section');
                if (subPages && subPages.length > 0) return Array.from(subPages);
            }
            return [];
        }

        // 辅助函数：滚动到第 N 页（从 1 开始），带重试以应对图片加载导致的重排
        function scrollToPageByIndex(containerId, pageIndex) {
            const container = document.getElementById(containerId);
            if (!container || pageIndex < 1) return;
            const doScroll = () => {
                const pages = getDocxPages(container);
                if (!pages || pages.length === 0) return false;
                const targetIndex = Math.min(pageIndex - 1, pages.length - 1);
                const target = pages[targetIndex];
                const top = target.getBoundingClientRect().top - container.getBoundingClientRect().top + container.scrollTop;
                container.scrollTo({ top, behavior: 'smooth' });
                return true;
            };
            if (!doScroll()) return;
            // 重试两次，处理异步资源加载后的布局变化
            setTimeout(doScroll, 200);
            setTimeout(doScroll, 800);
        }

        // 观察容器变化，持续尝试滚动，直至成功稳定或超时
        function ensureScrollToPage(containerId, pageIndex, timeoutMs = 5000) {
            const container = document.getElementById(containerId);
            if (!container) return;
            let disconnected = false;
            const observer = new MutationObserver(() => {
                scrollToPageByIndex(containerId, pageIndex);
            });
            try {
                observer.observe(container, { childList: true, subtree: true });
            } catch (_) {}
            // 初次与延迟重试
            scrollToPageByIndex(containerId, pageIndex);
            const t1 = setTimeout(() => scrollToPageByIndex(containerId, pageIndex), 300);
            const t2 = setTimeout(() => scrollToPageByIndex(containerId, pageIndex), 1200);
            // 超时后停止观察
            setTimeout(() => {
                if (!disconnected) {
                    observer.disconnect();
                    disconnected = true;
                }
                clearTimeout(t1);
                clearTimeout(t2);
            }, timeoutMs);
        }
        
        // 显示弹窗
        function showSourceModal() {
            modal.style.display = 'flex';
            renderWordDocuments();
        }

        // 渲染Word文档
        function renderWordDocuments() {
            // 渲染安东石油文档
            fetch('https://static-host-vsu1427n-test.sealoshzh.site/document/anton.docx')
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    const container = document.getElementById('anton-docx-container');
                    return docx.renderAsync(buffer, container, null, {
                        inWrapper: true,
                        ignoreWidth: false,
                        ignoreHeight: false
                    });
                })
                .then(() => {
                    // 渲染完成后小延迟，确保布局稳定再滚动并持续校正
                    setTimeout(() => {
                        ensureScrollToPage('anton-docx-container', 2);
                    }, 120);
                })
                .catch(error => {
                    console.error('加载安东石油文档失败:', error);
                    document.getElementById('anton-docx-container').innerHTML = '<p>文档加载失败，请检查文件路径或网络连接。</p>';
                });

            // 渲染斯伦贝谢文档
            fetch('https://static-host-vsu1427n-test.sealoshzh.site/document/斯伦贝谢.docx')
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    const container = document.getElementById('schlumberger-docx-container');
                    return docx.renderAsync(buffer, container, null, {
                        inWrapper: true,
                        ignoreWidth: false,
                        ignoreHeight: false
                    });
                })
                .then(() => {
                    // 渲染完成后小延迟，确保布局稳定再滚动并持续校正
                    setTimeout(() => {
                        ensureScrollToPage('schlumberger-docx-container', 5);
                    }, 120);
                })
                .catch(error => {
                    console.error('加载斯伦贝谢文档失败:', error);
                    document.getElementById('schlumberger-docx-container').innerHTML = '<p>文档加载失败，请检查文件路径或网络连接。</p>';
                });
        }
        
        // 发送消息
        function sendMessage() {
            const userText = chatInput.value.trim();
            if (!userText) return;

            appendMessage('user', userText);
            chatInput.value = '';

            setTimeout(() => {
                let response;
                if (userText.includes('总结安东和斯伦贝谢QHSE原则的差异')) {
                    response = {
                        summary: `以下是<strong>安东石油</strong>与<strong>斯伦贝谢（Schlumberger）</strong>在QHSE（质量、健康、安全、环境）管理原则方面的<strong>差异总结</strong>，基于双方公开政策文件内容整理：<br>
<h3>❗ <strong>不同点（差异分析）</strong></h3>
<table border="1" cellpadding="5" cellspacing="0">
<thead>
<tr>
<th>维度</th>
<th>安东石油</th>
<th>斯伦贝谢（Schlumberger）</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>核心价值观</strong></td>
<td>“<strong>先有QHSE，后有安东</strong>”——将QHSE作为企业存在的前提条件。</td>
<td>“<strong>Lead by example</strong>”——领导以身作则，文化驱动行为。</td>
</tr>
<tr>
<td><strong>愿景目标</strong></td>
<td>“零伤亡、零污染、零损失、零投诉”</td>
<td>未明确提出“四零”，但强调“<strong>持续改进</strong>”和“<strong>卓越绩效</strong>”。</td>
</tr>
<tr>
<td><strong>组织机制</strong></td>
<td>建立<strong>安委会</strong>统一领导，分级签订责任书，<strong>属地管理+责任制</strong>明确。</td>
</tr>
<tr>
<td><strong>斯伦贝谢（Schlumberger）</strong></td>
<td>强调<strong>Line Management（直线经理）负责制</strong>，HSE职能为支持与监督。</td>
</tr>
</tbody>
</table>
<br>
---<br><br>
<h3>✅ 总结一句话</h3>
<p>安东石油以“制度+文化+问责”三位一体，强调<strong>责任到人、属地严管</strong>；</p>
<p>斯伦贝谢则以“领导示范+体系标准+数据驱动”为核心，强调<strong>文化引领、持续改进</strong>。</p>`,
                        hasSource: true
                    };
                } else {
                    response = {
                        summary: "抱歉，此演示仅支持查看“总结安东和斯伦贝谢QHSE原则的差异”问题。",
                        hasSource: false
                    };
                }
                appendBotMessageWithSource(response);
            }, 800);
        }

        function appendMessage(sender, text) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${sender}-message`;
            const content = `<div class="message-content">${text}</div>`;
            messageEl.innerHTML = sender === 'bot'
                ? `<div class="avatar">智</div><div class="message-container">${content}</div>`
                : `<div class="message-container">${content}</div>`;
            chatBody.appendChild(messageEl);
            scrollToBottom();
        }

        function appendBotMessageWithSource(responseObj) {
            const messageEl = document.createElement('div');
            messageEl.className = 'message bot-message';
            const sourceLink = responseObj.hasSource
                ? `<div style="margin-top: 8px; font-size: 13px; color: #5f6368;"><a href="javascript:void(0)" class="source-link" style="color: #4A89E8; text-decoration: none;">🔍 查看参考来源</a></div>`
                : '';

            messageEl.innerHTML = `
                <div class="avatar">智</div>
                <div class="message-container">
                    <div class="message-content">${responseObj.summary}</div>
                    ${sourceLink}
                </div>
            `;
            chatBody.appendChild(messageEl);

            if (responseObj.hasSource) {
                messageEl.querySelector('.source-link').addEventListener('click', showSourceModal);
            }
            scrollToBottom();
        }

        function scrollToBottom() {
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 初始化
        scrollToBottom();

        // 添加推荐问题点击事件
        function selectQuestion(question) {
            chatInput.value = question;
            sendMessage();
        }
    </script>
</body>
</html>